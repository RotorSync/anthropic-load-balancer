<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anthropic Load Balancer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#0f1117',
                            card: '#1a1d27',
                            border: '#2a2e3a',
                            text: '#e4e4e7',
                            muted: '#71717a'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        html, body { 
            background: #0f1117; 
            height: 100%;
            overflow-x: hidden;
        }
        .glow-green { box-shadow: 0 0 10px rgba(34, 197, 94, 0.3); }
        .glow-amber { box-shadow: 0 0 10px rgba(245, 158, 11, 0.3); }
        .glow-red { box-shadow: 0 0 10px rgba(239, 68, 68, 0.3); }
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse-dot { animation: pulse-dot 2s infinite; }
    </style>
</head>
<body class="text-dark-text p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-2xl font-bold">Anthropic Load Balancer</h1>
                <p class="text-dark-muted text-sm">192.168.68.181:8080</p>
            </div>
            <div class="flex items-center gap-2">
                <span id="status-dot" class="w-3 h-3 rounded-full bg-green-500 pulse-dot"></span>
                <span id="status-text" class="text-sm text-dark-muted">Connected</span>
                <span class="text-dark-muted text-sm ml-4">Updated: <span id="last-updated">—</span></span>
            </div>
        </div>

        <!-- Stats Overview -->
        <div class="grid grid-cols-6 gap-4 mb-6">
            <div class="bg-dark-card rounded-lg p-4 border border-dark-border">
                <div class="text-dark-muted text-xs mb-1">Capacity</div>
                <div id="total-capacity" class="text-2xl font-bold">20</div>
            </div>
            <div class="bg-dark-card rounded-lg p-4 border border-dark-border">
                <div class="text-dark-muted text-xs mb-1">Active</div>
                <div id="active-now" class="text-2xl font-bold text-amber-500">0</div>
            </div>
            <div class="bg-dark-card rounded-lg p-4 border border-dark-border">
                <div class="text-dark-muted text-xs mb-1">Available</div>
                <div id="available" class="text-2xl font-bold text-green-500">20</div>
            </div>
            <div class="bg-dark-card rounded-lg p-4 border border-dark-border">
                <div class="text-dark-muted text-xs mb-1">Requests Today</div>
                <div id="requests-today" class="text-2xl font-bold">0</div>
            </div>
            <div class="bg-dark-card rounded-lg p-4 border border-dark-border">
                <div class="text-dark-muted text-xs mb-1">Tokens Today</div>
                <div id="tokens-today" class="text-2xl font-bold text-blue-400">0</div>
            </div>
            <div class="bg-dark-card rounded-lg p-4 border border-dark-border">
                <div class="text-dark-muted text-xs mb-1">Tokens This Week</div>
                <div id="tokens-week" class="text-2xl font-bold text-purple-400">0</div>
            </div>
        </div>

        <div class="grid grid-cols-3 gap-6">
            <!-- Left Column: Subscriptions & Clients -->
            <div class="col-span-2 space-y-6">
                <!-- Subscriptions -->
                <div class="bg-dark-card rounded-lg border border-dark-border">
                    <div class="p-3 border-b border-dark-border">
                        <h2 class="font-semibold text-sm">Subscriptions</h2>
                    </div>
                    <div class="p-4">
                        <div id="subscriptions" class="space-y-3">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Account Limits -->
                <div class="bg-dark-card rounded-lg border border-dark-border">
                    <div class="p-3 border-b border-dark-border flex items-center justify-between">
                        <h2 class="font-semibold text-sm">Account Limits</h2>
                        <span id="limits-updated" class="text-dark-muted text-xs"></span>
                    </div>
                    <div class="p-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <div class="text-xs text-dark-muted mb-2">5-Hour Utilization</div>
                                <div id="limits-5h" class="space-y-2">
                                    <div class="text-dark-muted text-xs">Loading...</div>
                                </div>
                            </div>
                            <div>
                                <div class="text-xs text-dark-muted mb-2">7-Day Utilization</div>
                                <div id="limits-7d" class="space-y-2">
                                    <div class="text-dark-muted text-xs">Loading...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Clients -->
                <div class="bg-dark-card rounded-lg border border-dark-border">
                    <div class="p-3 border-b border-dark-border">
                        <h2 class="font-semibold text-sm">Clients</h2>
                    </div>
                    <div class="p-4 max-h-64 overflow-y-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="text-dark-muted text-xs text-left">
                                    <th class="pb-2">Client</th>
                                    <th class="pb-2">Subscription</th>
                                    <th class="pb-2">Requests</th>
                                    <th class="pb-2">Tokens (Day)</th>
                                    <th class="pb-2">Tokens (Week)</th>
                                    <th class="pb-2">Last Seen</th>
                                </tr>
                            </thead>
                            <tbody id="clients-table" class="text-sm">
                                <tr>
                                    <td colspan="6" class="text-dark-muted text-center py-6">
                                        No clients yet
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Right Column: Usage -->
            <div class="space-y-6">
                <!-- Chart -->
                <div class="bg-dark-card rounded-lg border border-dark-border">
                    <div class="p-3 border-b border-dark-border flex items-center justify-between">
                        <h2 class="font-semibold text-sm">Token Usage</h2>
                        <div class="flex gap-1">
                            <button onclick="setPeriod('day')" id="btn-day" class="px-2 py-0.5 text-xs rounded bg-dark-border">Day</button>
                            <button onclick="setPeriod('week')" id="btn-week" class="px-2 py-0.5 text-xs rounded bg-blue-600">Week</button>
                            <button onclick="setPeriod('month')" id="btn-month" class="px-2 py-0.5 text-xs rounded bg-dark-border">Month</button>
                        </div>
                    </div>
                    <div class="p-4">
                        <div style="height: 180px;">
                            <canvas id="usage-chart"></canvas>
                        </div>
                        <div id="usage-total" class="text-center mt-3">
                            <span class="text-2xl font-bold">0</span>
                            <span class="text-dark-muted text-sm ml-1">tokens</span>
                        </div>
                    </div>
                </div>

                <!-- By Subscription -->
                <div class="bg-dark-card rounded-lg border border-dark-border">
                    <div class="p-3 border-b border-dark-border">
                        <h2 class="font-semibold text-sm">By Subscription</h2>
                    </div>
                    <div class="p-4">
                        <div id="usage-by-sub" class="space-y-2">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- By Client -->
                <div class="bg-dark-card rounded-lg border border-dark-border">
                    <div class="p-3 border-b border-dark-border">
                        <h2 class="font-semibold text-sm">By Client</h2>
                    </div>
                    <div class="p-4">
                        <div id="usage-by-client" class="space-y-2">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Bot Profiles -->
                <div class="bg-dark-card rounded-lg border border-dark-border">
                    <div class="p-3 border-b border-dark-border">
                        <h2 class="font-semibold text-sm">Bot Profiles</h2>
                    </div>
                    <div class="p-4">
                        <div id="bot-profiles" class="space-y-2 text-xs">
                            <div class="text-dark-muted">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Token Flow Visualization -->
        <div class="mt-6 bg-dark-card rounded-lg border border-dark-border">
            <div class="p-3 border-b border-dark-border flex items-center justify-between">
                <h2 class="font-semibold text-sm">Token Flow</h2>
                <div class="flex items-center gap-4 text-xs text-dark-muted">
                    <span class="flex items-center gap-1">
                        <span class="w-2 h-2 rounded-full bg-cyan-400"></span> Input
                    </span>
                    <span class="flex items-center gap-1">
                        <span class="w-2 h-2 rounded-full bg-purple-400"></span> Output
                    </span>
                </div>
            </div>
            <div class="p-4">
                <canvas id="flow-canvas" style="width: 100%; height: 280px;"></canvas>
            </div>
        </div>
    </div>

    <script>
        let currentPeriod = 'week';
        let usageChart = null;
        const subColors = {
            'hh': '#3b82f6',
            'cam': '#22c55e', 
            'norm': '#f59e0b',
            'headings2': '#8b5cf6'
        };
        const clientColors = ['#06b6d4', '#ec4899', '#84cc16', '#f97316', '#6366f1'];

        function formatNumber(n) {
            if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(1) + 'k';
            return n.toString();
        }

        function formatTime(iso) {
            if (!iso) return '—';
            const d = new Date(iso);
            const now = new Date();
            const diff = (now - d) / 1000;
            if (diff < 60) return 'just now';
            if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
            if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
            return d.toLocaleDateString();
        }

        function setPeriod(p) {
            currentPeriod = p;
            document.querySelectorAll('[id^="btn-"]').forEach(b => {
                b.className = b.id === 'btn-' + p 
                    ? 'px-2 py-0.5 text-xs rounded bg-blue-600'
                    : 'px-2 py-0.5 text-xs rounded bg-dark-border';
            });
            fetchUsage();
        }

        async function fetchClients() {
            try {
                const res = await fetch('/admin/clients');
                const data = await res.json();
                
                const live = data.live;
                document.getElementById('total-capacity').textContent = live.total_capacity;
                document.getElementById('active-now').textContent = live.total_active;
                document.getElementById('available').textContent = live.available_capacity;
                
                // Subscriptions
                const subsEl = document.getElementById('subscriptions');
                subsEl.innerHTML = live.subscriptions.map(sub => {
                    const name = String(sub.name || '');
                    const active = Number(sub.active_connections) || 0;
                    const max = Number(sub.max_concurrent) || 5;
                    const requests = Number(sub.total_requests) || 0;
                    const inCooldown = Boolean(sub.in_cooldown);
                    const pct = (active / max) * 100;
                    const color = inCooldown ? 'bg-red-500' : pct > 80 ? 'bg-amber-500' : 'bg-green-500';
                    return `
                        <div class="flex items-center gap-3">
                            <div class="w-16 font-mono text-sm">${name}</div>
                            <div class="flex-1 bg-dark-border rounded-full h-2 overflow-hidden">
                                <div class="${color} h-full transition-all" style="width: ${pct}%"></div>
                            </div>
                            <div class="text-xs text-dark-muted w-12 text-right">${active}/${max}</div>
                            <div class="text-xs text-dark-muted w-16 text-right">${formatNumber(requests)} req</div>
                            ${inCooldown ? '<span class="text-xs text-red-500">⚠</span>' : ''}
                        </div>
                    `;
                }).join('');

                // Clients table
                const clientsEl = document.getElementById('clients-table');
                if (data.clients.length === 0) {
                    clientsEl.innerHTML = `<tr><td colspan="6" class="text-dark-muted text-center py-6">No clients yet</td></tr>`;
                } else {
                    clientsEl.innerHTML = data.clients.map(c => {
                        const clientId = String(c.client_id || 'unknown');
                        const lastSub = String(c.last_subscription || '—');
                        const requests = Number(c.total_requests) || 0;
                        const tokensDay = Number(c.tokens_today || c.total_tokens) || 0;
                        const tokensWeek = Number(c.tokens_week || c.total_tokens) || 0;
                        const lastSeen = c.last_seen || '';
                        const subColor = subColors[lastSub] || '#666';
                        return `
                            <tr class="border-t border-dark-border">
                                <td class="py-2 font-mono">${clientId}</td>
                                <td class="py-2">
                                    <span class="px-1.5 py-0.5 rounded text-xs" style="background: ${subColor}20; color: ${subColor}">${lastSub}</span>
                                </td>
                                <td class="py-2">${formatNumber(requests)}</td>
                                <td class="py-2">${formatNumber(tokensDay)}</td>
                                <td class="py-2">${formatNumber(tokensWeek)}</td>
                                <td class="py-2 text-dark-muted">${formatTime(lastSeen)}</td>
                            </tr>
                        `;
                    }).join('');
                }

                // Stats
                const requestsToday = data.clients.reduce((sum, c) => sum + (c.requests_today || c.total_requests || 0), 0);
                const tokensToday = data.clients.reduce((sum, c) => sum + (c.tokens_today || c.total_tokens || 0), 0);
                document.getElementById('requests-today').textContent = formatNumber(requestsToday);
                document.getElementById('tokens-today').textContent = formatNumber(tokensToday);

                document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
                document.getElementById('status-dot').className = 'w-3 h-3 rounded-full bg-green-500 pulse-dot';
                document.getElementById('status-text').textContent = 'Connected';
            } catch (e) {
                console.error('Failed to fetch clients:', e);
                document.getElementById('status-dot').className = 'w-3 h-3 rounded-full bg-red-500';
                document.getElementById('status-text').textContent = 'Disconnected';
            }
        }

        async function fetchUsage() {
            try {
                const res = await fetch(`/admin/usage?period=${currentPeriod}`);
                const data = await res.json();

                const total = data.total_tokens || 0;
                document.getElementById('usage-total').innerHTML = `
                    <span class="text-2xl font-bold">${formatNumber(total)}</span>
                    <span class="text-dark-muted text-sm ml-1">tokens</span>
                `;

                // Update week tokens stat
                if (currentPeriod === 'week') {
                    document.getElementById('tokens-week').textContent = formatNumber(total);
                }

                // Chart
                const ctx = document.getElementById('usage-chart').getContext('2d');
                if (usageChart) usageChart.destroy();
                
                const labels = data.by_day?.map(d => {
                    const date = new Date(d.date);
                    return date.toLocaleDateString('en-US', { weekday: 'short' });
                }) || [];
                const datasets = Object.keys(subColors).map(sub => ({
                    label: sub,
                    data: data.by_day?.map(d => {
                        const info = d.by_subscription?.[sub];
                        if (typeof info === 'object') return (info.input_tokens || 0) + (info.output_tokens || 0);
                        return Number(info) || 0;
                    }) || [],
                    backgroundColor: subColors[sub],
                    borderRadius: 2
                }));

                usageChart = new Chart(ctx, {
                    type: 'bar',
                    data: { labels, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { stacked: true, grid: { display: false }, ticks: { color: '#71717a', font: { size: 10 } } },
                            y: { stacked: true, grid: { color: '#2a2e3a' }, ticks: { color: '#71717a', font: { size: 10 }, callback: v => formatNumber(v) } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });

                // By subscription
                const bySubEl = document.getElementById('usage-by-sub');
                const bySubData = data.by_subscription || {};
                // Extract token totals from subscription objects
                const subTotals = {};
                for (const [sub, info] of Object.entries(bySubData)) {
                    subTotals[sub] = typeof info === 'object' ? (info.input_tokens || 0) + (info.output_tokens || 0) : Number(info) || 0;
                }
                const maxSub = Math.max(...Object.values(subTotals), 1);
                bySubEl.innerHTML = Object.entries(subColors).map(([sub, color]) => {
                    const val = subTotals[sub] || 0;
                    const pct = (val / maxSub) * 100;
                    return `
                        <div>
                            <div class="flex justify-between text-xs mb-1">
                                <span>${sub}</span>
                                <span class="text-dark-muted">${formatNumber(val)}</span>
                            </div>
                            <div class="bg-dark-border rounded-full h-1.5 overflow-hidden">
                                <div style="width: ${pct}%; background: ${color}" class="h-full"></div>
                            </div>
                        </div>
                    `;
                }).join('');

                // By client
                const byClientEl = document.getElementById('usage-by-client');
                const byClientData = data.by_client || {};
                // Extract token totals from client objects
                const clientTotals = {};
                for (const [client, info] of Object.entries(byClientData)) {
                    clientTotals[client] = typeof info === 'object' ? (info.input_tokens || 0) + (info.output_tokens || 0) : Number(info) || 0;
                }
                const clientEntries = Object.entries(clientTotals).sort((a, b) => b[1] - a[1]);
                const maxClient = clientEntries.length > 0 ? clientEntries[0][1] : 1;
                byClientEl.innerHTML = clientEntries.length === 0 
                    ? '<div class="text-dark-muted text-xs text-center py-2">No data</div>'
                    : clientEntries.map(([client, val], i) => {
                        const pct = (val / maxClient) * 100;
                        const color = clientColors[i % clientColors.length];
                        return `
                            <div>
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="font-mono">${client}</span>
                                    <span class="text-dark-muted">${formatNumber(val)}</span>
                                </div>
                                <div class="bg-dark-border rounded-full h-1.5 overflow-hidden">
                                    <div style="width: ${pct}%; background: ${color}" class="h-full"></div>
                                </div>
                            </div>
                        `;
                    }).join('');

            } catch (e) {
                console.error('Failed to fetch usage:', e);
            }
        }

        async function fetchLimits() {
            try {
                const res = await fetch('/admin/limits');
                const data = await res.json();
                
                const accounts = data.accounts || [];
                const limits5h = document.getElementById('limits-5h');
                const limits7d = document.getElementById('limits-7d');
                
                function renderBar(account, period) {
                    const util = Number(account[period]?.utilization) || 0;
                    const resets = account[period]?.resets_at;
                    const resetTime = resets ? new Date(resets) : null;
                    const now = new Date();
                    const hoursLeft = resetTime ? Math.max(0, (resetTime - now) / 3600000) : 0;
                    const resetStr = hoursLeft > 24 ? `${Math.floor(hoursLeft / 24)}d` : `${Math.floor(hoursLeft)}h`;
                    
                    const color = util >= 80 ? 'bg-red-500' : util >= 50 ? 'bg-amber-500' : 'bg-green-500';
                    const name = account.id || 'unknown';
                    
                    return `
                        <div class="flex items-center gap-2">
                            <div class="w-14 text-xs font-mono">${name}</div>
                            <div class="flex-1 bg-dark-border rounded-full h-2 overflow-hidden">
                                <div class="${color} h-full" style="width: ${util}%"></div>
                            </div>
                            <div class="text-xs text-dark-muted w-10 text-right">${util}%</div>
                            <div class="text-xs text-dark-muted w-8 text-right">${resetStr}</div>
                        </div>
                    `;
                }
                
                limits5h.innerHTML = accounts.map(a => renderBar(a, 'five_hour')).join('');
                limits7d.innerHTML = accounts.map(a => renderBar(a, 'seven_day')).join('');
                
                document.getElementById('limits-updated').textContent = 
                    data.fetched_at ? new Date(data.fetched_at).toLocaleTimeString() : '';
            } catch (e) {
                console.error('Failed to fetch limits:', e);
                document.getElementById('limits-5h').innerHTML = '<div class="text-red-400 text-xs">Failed to load</div>';
                document.getElementById('limits-7d').innerHTML = '<div class="text-red-400 text-xs">Failed to load</div>';
            }
        }

        async function fetchProfiles() {
            try {
                const res = await fetch('/admin/profiles');
                const data = await res.json();
                
                const profilesEl = document.getElementById('bot-profiles');
                const profiles = data.profiles || {};
                const entries = Object.entries(profiles);
                
                if (entries.length === 0) {
                    profilesEl.innerHTML = '<div class="text-dark-muted">No bot data yet</div>';
                    return;
                }
                
                const classColors = {
                    light: 'text-green-400',
                    medium: 'text-amber-400', 
                    heavy: 'text-red-400'
                };
                
                profilesEl.innerHTML = entries.map(([bot, profile]) => {
                    const cls = profile.classification || 'light';
                    const color = classColors[cls] || 'text-dark-muted';
                    return `
                        <div class="flex justify-between items-center">
                            <span class="font-mono">${bot}</span>
                            <span class="${color} font-semibold">${cls.toUpperCase()}</span>
                        </div>
                        <div class="text-dark-muted mb-2">
                            ${formatNumber(profile.avg_tokens_day)}/day · ${profile.avg_requests_hour} req/hr
                        </div>
                    `;
                }).join('');
            } catch (e) {
                console.error('Failed to fetch profiles:', e);
            }
        }

        // Initial load
        fetchClients();
        fetchUsage();
        fetchLimits();
        fetchProfiles();

        // Auto-refresh
        setInterval(fetchClients, 5000);
        setInterval(fetchUsage, 30000);
        setInterval(fetchLimits, 60000);
        setInterval(fetchProfiles, 60000);

        // ========== TOKEN FLOW VISUALIZATION ==========
        const flowCanvas = document.getElementById('flow-canvas');
        const flowCtx = flowCanvas.getContext('2d');
        let flowParticles = [];
        let flowClients = [];
        let flowSubs = [];
        
        function resizeFlowCanvas() {
            const rect = flowCanvas.getBoundingClientRect();
            flowCanvas.width = rect.width * window.devicePixelRatio;
            flowCanvas.height = rect.height * window.devicePixelRatio;
            flowCtx.scale(window.devicePixelRatio, window.devicePixelRatio);
        }
        resizeFlowCanvas();
        window.addEventListener('resize', resizeFlowCanvas);

        class FlowParticle {
            constructor(startX, startY, endX, endY, color, size) {
                this.startX = startX;
                this.startY = startY;
                this.endX = endX;
                this.endY = endY;
                this.color = color;
                this.size = size;
                this.progress = 0;
                this.speed = 0.008 + Math.random() * 0.008;
                this.trail = [];
            }
            
            update() {
                this.progress += this.speed;
                const x = this.startX + (this.endX - this.startX) * this.easeInOut(this.progress);
                const y = this.startY + (this.endY - this.startY) * this.easeInOut(this.progress);
                this.trail.unshift({ x, y, alpha: 1 });
                if (this.trail.length > 12) this.trail.pop();
                this.trail.forEach((p, i) => p.alpha = 1 - (i / 12));
                return this.progress < 1;
            }
            
            easeInOut(t) {
                return t < 0.5 ? 2 * t * t : 1 - Math.pow(-2 * t + 2, 2) / 2;
            }
            
            draw(ctx) {
                // Trail
                this.trail.forEach((p, i) => {
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, this.size * (1 - i * 0.06), 0, Math.PI * 2);
                    ctx.fillStyle = this.color.replace('1)', `${p.alpha * 0.6})`);
                    ctx.fill();
                });
                // Head glow
                if (this.trail.length > 0) {
                    const head = this.trail[0];
                    ctx.beginPath();
                    ctx.arc(head.x, head.y, this.size * 2, 0, Math.PI * 2);
                    const gradient = ctx.createRadialGradient(head.x, head.y, 0, head.x, head.y, this.size * 2);
                    gradient.addColorStop(0, this.color.replace('1)', '0.8)'));
                    gradient.addColorStop(1, this.color.replace('1)', '0)'));
                    ctx.fillStyle = gradient;
                    ctx.fill();
                }
            }
        }

        function spawnParticle(clientIdx, subIdx, isInput) {
            const rect = flowCanvas.getBoundingClientRect();
            const w = rect.width;
            const h = rect.height;
            const centerX = w / 2;
            const centerY = h / 2;
            
            const clientY = 40 + clientIdx * 50;
            const subY = 40 + subIdx * 55;
            
            const startX = isInput ? 80 : centerX;
            const startY = isInput ? clientY : centerY;
            const endX = isInput ? centerX : w - 80;
            const endY = isInput ? centerY : subY;
            
            const color = isInput ? 'rgba(34, 211, 238, 1)' : 'rgba(192, 132, 252, 1)';
            const size = 2 + Math.random() * 2;
            
            flowParticles.push(new FlowParticle(startX, startY, endX, endY, color, size));
        }

        function drawFlowViz() {
            const rect = flowCanvas.getBoundingClientRect();
            const w = rect.width;
            const h = rect.height;
            const centerX = w / 2;
            const centerY = h / 2;
            
            flowCtx.clearRect(0, 0, w, h);
            
            // Draw connection lines (faint)
            flowCtx.strokeStyle = 'rgba(42, 46, 58, 0.5)';
            flowCtx.lineWidth = 1;
            
            flowClients.forEach((client, i) => {
                const y = 40 + i * 50;
                flowCtx.beginPath();
                flowCtx.moveTo(80, y);
                flowCtx.quadraticCurveTo(centerX - 40, y, centerX, centerY);
                flowCtx.stroke();
            });
            
            flowSubs.forEach((sub, i) => {
                const y = 40 + i * 55;
                flowCtx.beginPath();
                flowCtx.moveTo(centerX, centerY);
                flowCtx.quadraticCurveTo(centerX + 40, y, w - 80, y);
                flowCtx.stroke();
            });
            
            // Draw clients (left)
            flowClients.forEach((client, i) => {
                const y = 40 + i * 50;
                flowCtx.fillStyle = '#1a1d27';
                flowCtx.strokeStyle = clientColors[i % clientColors.length];
                flowCtx.lineWidth = 2;
                flowCtx.beginPath();
                flowCtx.roundRect(10, y - 15, 70, 30, 6);
                flowCtx.fill();
                flowCtx.stroke();
                flowCtx.fillStyle = '#e4e4e7';
                flowCtx.font = '11px monospace';
                flowCtx.textAlign = 'center';
                flowCtx.fillText(client.slice(0, 8), 45, y + 4);
            });
            
            // Draw load balancer (center)
            const lbGradient = flowCtx.createRadialGradient(centerX, centerY, 0, centerX, centerY, 50);
            lbGradient.addColorStop(0, 'rgba(59, 130, 246, 0.3)');
            lbGradient.addColorStop(1, 'rgba(59, 130, 246, 0)');
            flowCtx.fillStyle = lbGradient;
            flowCtx.beginPath();
            flowCtx.arc(centerX, centerY, 50, 0, Math.PI * 2);
            flowCtx.fill();
            
            flowCtx.fillStyle = '#1a1d27';
            flowCtx.strokeStyle = '#3b82f6';
            flowCtx.lineWidth = 2;
            flowCtx.beginPath();
            flowCtx.arc(centerX, centerY, 35, 0, Math.PI * 2);
            flowCtx.fill();
            flowCtx.stroke();
            flowCtx.fillStyle = '#e4e4e7';
            flowCtx.font = 'bold 10px sans-serif';
            flowCtx.textAlign = 'center';
            flowCtx.fillText('LOAD', centerX, centerY - 4);
            flowCtx.fillText('BALANCER', centerX, centerY + 8);
            
            // Draw subscriptions (right)
            flowSubs.forEach((sub, i) => {
                const y = 40 + i * 55;
                const color = subColors[sub] || '#666';
                flowCtx.fillStyle = '#1a1d27';
                flowCtx.strokeStyle = color;
                flowCtx.lineWidth = 2;
                flowCtx.beginPath();
                flowCtx.roundRect(w - 80, y - 18, 70, 36, 6);
                flowCtx.fill();
                flowCtx.stroke();
                flowCtx.fillStyle = '#e4e4e7';
                flowCtx.font = 'bold 12px monospace';
                flowCtx.textAlign = 'center';
                flowCtx.fillText(sub.toUpperCase(), w - 45, y + 5);
            });
            
            // Update and draw particles
            flowParticles = flowParticles.filter(p => {
                const alive = p.update();
                p.draw(flowCtx);
                return alive;
            });
        }

        function updateFlowData() {
            fetch('/admin/clients').then(r => r.json()).then(data => {
                flowClients = data.clients.map(c => c.client_id).slice(0, 5);
                flowSubs = data.live.subscriptions.map(s => s.name);
                
                // Spawn particles based on recent activity
                data.clients.forEach((client, ci) => {
                    if (ci >= 5) return;
                    const subIdx = flowSubs.indexOf(client.last_subscription);
                    if (subIdx >= 0 && Math.random() < 0.3) {
                        spawnParticle(ci, subIdx, true);  // Input
                        setTimeout(() => spawnParticle(ci, subIdx, false), 200 + Math.random() * 300);  // Output
                    }
                });
            }).catch(() => {});
        }

        // Animation loop
        function animateFlow() {
            drawFlowViz();
            requestAnimationFrame(animateFlow);
        }
        
        // Initialize
        updateFlowData();
        setInterval(updateFlowData, 3000);
        animateFlow();
    </script>
</body>
</html>
