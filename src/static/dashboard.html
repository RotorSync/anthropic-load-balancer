<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anthropic Load Balancer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#0f1117',
                            card: '#1a1d27',
                            border: '#2a2e3a',
                            text: '#e4e4e7',
                            muted: '#71717a'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { background: #0f1117; }
        .glow-green { box-shadow: 0 0 10px rgba(34, 197, 94, 0.3); }
        .glow-amber { box-shadow: 0 0 10px rgba(245, 158, 11, 0.3); }
        .glow-red { box-shadow: 0 0 10px rgba(239, 68, 68, 0.3); }
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse-dot { animation: pulse-dot 2s infinite; }
    </style>
</head>
<body class="text-dark-text min-h-screen p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-2xl font-bold">Anthropic Load Balancer</h1>
                <p class="text-dark-muted text-sm">192.168.68.181:8080</p>
            </div>
            <div class="flex items-center gap-2">
                <span id="status-dot" class="w-3 h-3 rounded-full bg-green-500 pulse-dot"></span>
                <span id="status-text" class="text-sm text-dark-muted">Connected</span>
            </div>
        </div>

        <!-- Capacity Overview -->
        <div class="grid grid-cols-4 gap-4 mb-8">
            <div class="bg-dark-card rounded-lg p-4 border border-dark-border">
                <div class="text-dark-muted text-sm mb-1">Total Capacity</div>
                <div id="total-capacity" class="text-3xl font-bold">20</div>
            </div>
            <div class="bg-dark-card rounded-lg p-4 border border-dark-border">
                <div class="text-dark-muted text-sm mb-1">Active Now</div>
                <div id="active-now" class="text-3xl font-bold text-amber-500">0</div>
            </div>
            <div class="bg-dark-card rounded-lg p-4 border border-dark-border">
                <div class="text-dark-muted text-sm mb-1">Available</div>
                <div id="available" class="text-3xl font-bold text-green-500">20</div>
            </div>
            <div class="bg-dark-card rounded-lg p-4 border border-dark-border">
                <div class="text-dark-muted text-sm mb-1">Requests Today</div>
                <div id="requests-today" class="text-3xl font-bold">0</div>
            </div>
        </div>

        <div class="grid grid-cols-3 gap-6">
            <!-- Left Column: Subscriptions & Active Clients -->
            <div class="col-span-2 space-y-6">
                <!-- Subscriptions -->
                <div class="bg-dark-card rounded-lg border border-dark-border">
                    <div class="p-4 border-b border-dark-border">
                        <h2 class="font-semibold">Subscriptions</h2>
                    </div>
                    <div class="p-4">
                        <div id="subscriptions" class="space-y-3">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Active Clients -->
                <div class="bg-dark-card rounded-lg border border-dark-border">
                    <div class="p-4 border-b border-dark-border">
                        <h2 class="font-semibold">Clients</h2>
                    </div>
                    <div class="p-4">
                        <table class="w-full">
                            <thead>
                                <tr class="text-dark-muted text-sm text-left">
                                    <th class="pb-3">Client</th>
                                    <th class="pb-3">Last Subscription</th>
                                    <th class="pb-3">Requests</th>
                                    <th class="pb-3">Tokens (Day)</th>
                                    <th class="pb-3">Last Seen</th>
                                </tr>
                            </thead>
                            <tbody id="clients-table">
                                <tr>
                                    <td colspan="5" class="text-dark-muted text-center py-8">
                                        No clients yet. Configure bots with X-Client-ID header.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Right Column: Usage Chart -->
            <div class="space-y-6">
                <!-- Period Selector -->
                <div class="bg-dark-card rounded-lg border border-dark-border">
                    <div class="p-4 border-b border-dark-border flex items-center justify-between">
                        <h2 class="font-semibold">Token Usage</h2>
                        <div class="flex gap-1">
                            <button onclick="setPeriod('day')" id="btn-day" class="px-3 py-1 text-sm rounded bg-dark-border">Day</button>
                            <button onclick="setPeriod('week')" id="btn-week" class="px-3 py-1 text-sm rounded bg-blue-600">Week</button>
                            <button onclick="setPeriod('month')" id="btn-month" class="px-3 py-1 text-sm rounded bg-dark-border">Month</button>
                        </div>
                    </div>
                    <div class="p-4">
                        <canvas id="usage-chart" height="200"></canvas>
                        <div id="usage-total" class="text-center mt-4">
                            <span class="text-3xl font-bold">0</span>
                            <span class="text-dark-muted ml-1">tokens</span>
                        </div>
                    </div>
                </div>

                <!-- By Subscription -->
                <div class="bg-dark-card rounded-lg border border-dark-border">
                    <div class="p-4 border-b border-dark-border">
                        <h2 class="font-semibold">By Subscription</h2>
                    </div>
                    <div class="p-4">
                        <div id="usage-by-sub" class="space-y-3">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="mt-8 text-center text-dark-muted text-sm">
            Last updated: <span id="last-updated">—</span>
        </div>
    </div>

    <script>
        let currentPeriod = 'week';
        let usageChart = null;
        const subColors = {
            'hh': '#3b82f6',
            'cam': '#22c55e', 
            'norm': '#f59e0b',
            'headings2': '#8b5cf6'
        };

        function formatNumber(n) {
            if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(1) + 'k';
            return n.toString();
        }

        function formatTime(iso) {
            if (!iso) return '—';
            const d = new Date(iso);
            const now = new Date();
            const diff = (now - d) / 1000;
            if (diff < 60) return 'just now';
            if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
            if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
            return d.toLocaleDateString();
        }

        function setPeriod(p) {
            currentPeriod = p;
            document.querySelectorAll('[id^="btn-"]').forEach(b => {
                b.className = b.id === 'btn-' + p 
                    ? 'px-3 py-1 text-sm rounded bg-blue-600'
                    : 'px-3 py-1 text-sm rounded bg-dark-border';
            });
            fetchUsage();
        }

        async function fetchClients() {
            try {
                const res = await fetch('/admin/clients');
                const data = await res.json();
                
                // Update capacity cards
                const live = data.live;
                document.getElementById('total-capacity').textContent = live.total_capacity;
                document.getElementById('active-now').textContent = live.total_active;
                document.getElementById('available').textContent = live.available_capacity;
                
                // Update subscriptions
                const subsEl = document.getElementById('subscriptions');
                subsEl.innerHTML = live.subscriptions.map(sub => {
                    const pct = (sub.active_connections / sub.max_concurrent) * 100;
                    const color = sub.in_cooldown ? 'bg-red-500' : 
                                  pct > 80 ? 'bg-amber-500' : 'bg-green-500';
                    return `
                        <div class="flex items-center gap-4">
                            <div class="w-20 font-mono text-sm">${sub.name}</div>
                            <div class="flex-1 bg-dark-border rounded-full h-2 overflow-hidden">
                                <div class="${color} h-full transition-all" style="width: ${pct}%"></div>
                            </div>
                            <div class="text-sm text-dark-muted w-16 text-right">
                                ${sub.active_connections}/${sub.max_concurrent}
                            </div>
                            ${sub.in_cooldown ? '<span class="text-xs text-red-500">COOLDOWN</span>' : ''}
                        </div>
                    `;
                }).join('');

                // Update clients table
                const clientsEl = document.getElementById('clients-table');
                if (data.clients.length === 0) {
                    clientsEl.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-dark-muted text-center py-8">
                                No clients yet. Configure bots with X-Client-ID header.
                            </td>
                        </tr>
                    `;
                } else {
                    clientsEl.innerHTML = data.clients.map(c => `
                        <tr class="border-t border-dark-border">
                            <td class="py-3 font-mono">${c.client_id}</td>
                            <td class="py-3">
                                <span class="px-2 py-1 rounded text-xs" style="background: ${subColors[c.last_subscription] || '#666'}20; color: ${subColors[c.last_subscription] || '#666'}">
                                    ${c.last_subscription || '—'}
                                </span>
                            </td>
                            <td class="py-3">${formatNumber(c.total_requests)}</td>
                            <td class="py-3">${formatNumber(c.tokens_today || 0)}</td>
                            <td class="py-3 text-dark-muted text-sm">${formatTime(c.last_seen)}</td>
                        </tr>
                    `).join('');
                }

                // Compute requests today
                const requestsToday = data.clients.reduce((sum, c) => sum + (c.requests_today || 0), 0);
                document.getElementById('requests-today').textContent = formatNumber(requestsToday);

                document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
            } catch (e) {
                console.error('Failed to fetch clients:', e);
                document.getElementById('status-dot').className = 'w-3 h-3 rounded-full bg-red-500';
                document.getElementById('status-text').textContent = 'Disconnected';
            }
        }

        async function fetchUsage() {
            try {
                const res = await fetch(`/admin/usage?period=${currentPeriod}`);
                const data = await res.json();

                // Update total
                const total = data.total_tokens || 0;
                document.getElementById('usage-total').innerHTML = `
                    <span class="text-3xl font-bold">${formatNumber(total)}</span>
                    <span class="text-dark-muted ml-1">tokens</span>
                `;

                // Update chart
                const ctx = document.getElementById('usage-chart').getContext('2d');
                if (usageChart) usageChart.destroy();
                
                const labels = data.by_day?.map(d => d.date) || [];
                const datasets = Object.keys(subColors).map(sub => ({
                    label: sub,
                    data: data.by_day?.map(d => d.by_subscription?.[sub] || 0) || [],
                    backgroundColor: subColors[sub],
                    borderRadius: 4
                }));

                usageChart = new Chart(ctx, {
                    type: 'bar',
                    data: { labels, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { stacked: true, grid: { color: '#2a2e3a' }, ticks: { color: '#71717a' } },
                            y: { stacked: true, grid: { color: '#2a2e3a' }, ticks: { color: '#71717a', callback: v => formatNumber(v) } }
                        },
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });

                // Update by-subscription breakdown
                const bySubEl = document.getElementById('usage-by-sub');
                const bySubData = data.by_subscription || {};
                const maxSub = Math.max(...Object.values(bySubData), 1);
                bySubEl.innerHTML = Object.entries(subColors).map(([sub, color]) => {
                    const val = bySubData[sub] || 0;
                    const pct = (val / maxSub) * 100;
                    return `
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span>${sub}</span>
                                <span class="text-dark-muted">${formatNumber(val)}</span>
                            </div>
                            <div class="bg-dark-border rounded-full h-2 overflow-hidden">
                                <div style="width: ${pct}%; background: ${color}" class="h-full"></div>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (e) {
                console.error('Failed to fetch usage:', e);
            }
        }

        // Initial load
        fetchClients();
        fetchUsage();

        // Auto-refresh every 5 seconds
        setInterval(fetchClients, 5000);
        setInterval(fetchUsage, 30000);
    </script>
</body>
</html>
