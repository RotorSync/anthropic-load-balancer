<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anthropic Load Balancer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { dark: { bg: '#0f1117', card: '#1a1d27', border: '#2a2e3a', text: '#e4e4e7', muted: '#71717a' } } } }
        }
    </script>
    <style>
        html, body { background: #0f1117; height: 100%; margin: 0; overflow: hidden; }
        .pulse-dot { animation: pulse-dot 2s infinite; }
        @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes pulse-green { 0%, 100% { box-shadow: 0 0 4px #22c55e; } 50% { box-shadow: 0 0 12px #22c55e, 0 0 20px #22c55e40; } }
        .active-client { animation: pulse-green 1s infinite; border-color: #22c55e !important; }
    </style>
</head>
<body class="text-dark-text p-3 h-screen">
    <div class="h-full flex flex-col max-w-[1400px] mx-auto">
        <!-- Header -->
        <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-3">
                <svg class="w-7 h-7" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" class="text-blue-500"/>
                    <path d="M12 6v6l4 2" class="text-blue-400"/>
                    <circle cx="12" cy="12" r="3" fill="#3b82f6"/>
                </svg>
                <div>
                    <h1 class="text-lg font-bold">Anthropic Load Balancer</h1>
                    <span class="text-dark-muted text-[10px] italic">Balancing your stupidityâ„¢</span>
                </div>
            </div>
            <div class="flex items-center gap-2 text-xs">
                <span id="status-dot" class="w-2 h-2 rounded-full bg-green-500 pulse-dot"></span>
                <span id="status-text" class="text-dark-muted">Connected</span>
                <span class="text-dark-muted ml-2">Updated: <span id="last-updated">â€”</span></span>
            </div>
        </div>

        <!-- Stats Row -->
        <div class="grid grid-cols-6 gap-2 mb-2">
            <div class="bg-dark-card rounded p-1.5 border border-dark-border text-center">
                <div class="text-dark-muted text-[10px]">Capacity</div>
                <div id="total-capacity" class="text-lg font-bold">20</div>
            </div>
            <div class="bg-dark-card rounded p-1.5 border border-dark-border text-center">
                <div class="text-dark-muted text-[10px]">Active</div>
                <div id="active-now" class="text-lg font-bold text-amber-500">0</div>
            </div>
            <div class="bg-dark-card rounded p-1.5 border border-dark-border text-center">
                <div class="text-dark-muted text-[10px]">Available</div>
                <div id="available" class="text-lg font-bold text-green-500">20</div>
            </div>
            <div class="bg-dark-card rounded p-1.5 border border-dark-border text-center">
                <div class="text-dark-muted text-[10px]">Requests</div>
                <div id="requests-today" class="text-lg font-bold">0</div>
            </div>
            <div class="bg-dark-card rounded p-1.5 border border-dark-border text-center">
                <div class="text-dark-muted text-[10px]">Tokens Today</div>
                <div id="tokens-today" class="text-lg font-bold text-blue-400">0</div>
            </div>
            <div class="bg-dark-card rounded p-1.5 border border-dark-border text-center">
                <div class="text-dark-muted text-[10px]">Tokens Week</div>
                <div id="tokens-week" class="text-lg font-bold text-purple-400">0</div>
            </div>
        </div>

        <!-- Main Grid: Left 2/3, Right 1/3 -->
        <div class="grid grid-cols-3 gap-2 mb-2" style="height: 45%;">
            <!-- Left Column -->
            <div class="col-span-2 grid grid-rows-2 gap-2">
                <!-- Top: Subs + Limits -->
                <div class="grid grid-cols-2 gap-2">
                    <div class="bg-dark-card rounded border border-dark-border flex flex-col">
                        <div class="px-2 py-1 border-b border-dark-border"><h2 class="font-semibold text-[11px]">Subscriptions</h2></div>
                        <div class="p-2 flex-1"><div id="subscriptions" class="space-y-1.5"></div></div>
                    </div>
                    <div class="bg-dark-card rounded border border-dark-border flex flex-col">
                        <div class="px-2 py-1 border-b border-dark-border flex justify-between">
                            <h2 class="font-semibold text-[11px]">Account Limits</h2>
                            <span id="limits-updated" class="text-dark-muted text-[10px]"></span>
                        </div>
                        <div class="p-2 flex-1 grid grid-cols-2 gap-3 text-[10px]">
                            <div><div class="text-dark-muted mb-1.5 font-semibold">5-Hour</div><div id="limits-5h" class="space-y-1.5"></div></div>
                            <div><div class="text-dark-muted mb-1.5 font-semibold">7-Day</div><div id="limits-7d" class="space-y-1.5"></div></div>
                        </div>
                    </div>
                </div>
                <!-- Bottom: Clients -->
                <div class="bg-dark-card rounded border border-dark-border flex flex-col">
                    <div class="px-2 py-1 border-b border-dark-border"><h2 class="font-semibold text-[11px]">Clients</h2></div>
                    <div class="p-2 flex-1 overflow-y-auto">
                        <table class="w-full text-[10px]">
                            <thead><tr class="text-dark-muted text-left"><th class="pb-1">Client</th><th class="pb-1">Sub</th><th class="pb-1">Req</th><th class="pb-1">Day</th><th class="pb-1">Week</th><th class="pb-1">Last</th></tr></thead>
                            <tbody id="clients-table"><tr><td colspan="6" class="text-dark-muted text-center py-2">No clients</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="flex flex-col gap-2">
                <!-- Usage Chart -->
                <div class="bg-dark-card rounded border border-dark-border">
                    <div class="px-2 py-1 border-b border-dark-border flex justify-between items-center">
                        <h2 class="font-semibold text-[11px]">Usage</h2>
                        <div class="flex gap-0.5">
                            <button onclick="setPeriod('day')" id="btn-day" class="px-1 text-[10px] rounded bg-dark-border">D</button>
                            <button onclick="setPeriod('week')" id="btn-week" class="px-1 text-[10px] rounded bg-blue-600">W</button>
                            <button onclick="setPeriod('month')" id="btn-month" class="px-1 text-[10px] rounded bg-dark-border">M</button>
                        </div>
                    </div>
                    <div class="p-2">
                        <div style="height: 70px;"><canvas id="usage-chart"></canvas></div>
                        <div id="usage-total" class="text-center text-sm font-bold">0 <span class="text-dark-muted text-[10px] font-normal">tokens</span></div>
                    </div>
                </div>
                <!-- Breakdown -->
                <div class="bg-dark-card rounded border border-dark-border flex-1">
                    <div class="px-2 py-1 border-b border-dark-border"><h2 class="font-semibold text-[11px]">Breakdown</h2></div>
                    <div class="p-2 grid grid-cols-2 gap-2 text-[10px]">
                        <div><div class="text-dark-muted mb-1">By Subscription</div><div id="usage-by-sub" class="space-y-1"></div></div>
                        <div><div class="text-dark-muted mb-1">By Client</div><div id="usage-by-client" class="space-y-1"></div></div>
                    </div>
                </div>
                <!-- Bot Profiles -->
                <div class="bg-dark-card rounded border border-dark-border">
                    <div class="px-2 py-1 border-b border-dark-border"><h2 class="font-semibold text-[11px]">Bot Profiles</h2></div>
                    <div class="p-2"><div id="bot-profiles" class="space-y-1 text-[10px]"></div></div>
                </div>
            </div>
        </div>

        <!-- Token Flow - Full Width -->
        <div class="bg-dark-card rounded border border-dark-border flex-1 flex flex-col min-h-0">
            <div class="px-2 py-1 border-b border-dark-border flex justify-between items-center">
                <h2 class="font-semibold text-[11px]">Token Flow</h2>
                <div class="flex gap-2 text-[10px] text-dark-muted">
                    <span class="flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-cyan-400"></span>In</span>
                    <span class="flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-purple-400"></span>Out</span>
                </div>
            </div>
            <div class="flex-1 p-1 min-h-0">
                <canvas id="flow-canvas" class="w-full h-full"></canvas>
            </div>
        </div>
    </div>

    <script>
        let currentPeriod = 'week', usageChart = null;
        const subColors = { 'hh': '#3b82f6', 'cam': '#22c55e', 'norm': '#f59e0b', 'headings2': '#8b5cf6' };
        const clientColors = ['#06b6d4', '#ec4899', '#84cc16', '#f97316', '#6366f1'];

        function formatNumber(n) { if (n >= 1e6) return (n/1e6).toFixed(1)+'M'; if (n >= 1e3) return (n/1e3).toFixed(1)+'k'; return n.toString(); }
        function formatTime(iso) { if (!iso) return 'â€”'; const d = new Date(iso), diff = (Date.now() - d) / 1000; if (diff < 60) return 'now'; if (diff < 3600) return Math.floor(diff/60)+'m'; if (diff < 86400) return Math.floor(diff/3600)+'h'; return d.toLocaleDateString(); }
        function setPeriod(p) { currentPeriod = p; document.querySelectorAll('[id^="btn-"]').forEach(b => b.className = b.id === 'btn-'+p ? 'px-1 text-[10px] rounded bg-blue-600' : 'px-1 text-[10px] rounded bg-dark-border'); fetchUsage(); }

        async function fetchClients() {
            try {
                const data = await (await fetch('/admin/clients')).json(), live = data.live;
                document.getElementById('total-capacity').textContent = live.total_capacity;
                document.getElementById('active-now').textContent = live.total_active;
                document.getElementById('available').textContent = live.available_capacity;
                document.getElementById('subscriptions').innerHTML = live.subscriptions.map(s => {
                    const pct = ((s.active_connections||0) / (s.max_concurrent||5)) * 100, color = s.in_cooldown ? 'bg-red-500' : pct > 80 ? 'bg-amber-500' : 'bg-green-500';
                    return `<div class="flex items-center gap-2 text-[10px]"><span class="w-12 font-mono">${s.name}</span><div class="flex-1 bg-dark-border rounded-full h-1.5"><div class="${color} h-full rounded-full" style="width:${pct}%"></div></div><span class="text-dark-muted w-8 text-right">${s.active_connections}/${s.max_concurrent}</span>${s.in_cooldown?'<span class="text-red-500">âš </span>':''}</div>`;
                }).join('');
                document.getElementById('clients-table').innerHTML = data.clients.length === 0 ? '<tr><td colspan="6" class="text-dark-muted text-center py-2">No clients</td></tr>' : data.clients.map(c => {
                    const sc = subColors[c.last_subscription] || '#666';
                    return `<tr class="border-t border-dark-border"><td class="py-0.5 font-mono">${c.client_id}</td><td class="py-0.5"><span class="px-1 rounded" style="background:${sc}20;color:${sc}">${c.last_subscription||'â€”'}</span></td><td class="py-0.5">${formatNumber(c.total_requests||0)}</td><td class="py-0.5">${formatNumber(c.tokens_today||c.total_tokens||0)}</td><td class="py-0.5">${formatNumber(c.tokens_week||c.total_tokens||0)}</td><td class="py-0.5 text-dark-muted">${formatTime(c.last_seen)}</td></tr>`;
                }).join('');
                document.getElementById('requests-today').textContent = formatNumber(data.clients.reduce((s,c) => s + (c.requests_today||c.total_requests||0), 0));
                document.getElementById('tokens-today').textContent = formatNumber(data.clients.reduce((s,c) => s + (c.tokens_today||c.total_tokens||0), 0));
                document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
                document.getElementById('status-dot').className = 'w-2 h-2 rounded-full bg-green-500 pulse-dot';
            } catch (e) { document.getElementById('status-dot').className = 'w-2 h-2 rounded-full bg-red-500'; document.getElementById('status-text').textContent = 'Disconnected'; }
        }

        async function fetchUsage() {
            try {
                const data = await (await fetch(`/admin/usage?period=${currentPeriod}`)).json(), total = data.total_tokens || 0;
                document.getElementById('usage-total').innerHTML = `${formatNumber(total)} <span class="text-dark-muted text-[10px] font-normal">tokens</span>`;
                if (currentPeriod === 'week') document.getElementById('tokens-week').textContent = formatNumber(total);
                const ctx = document.getElementById('usage-chart').getContext('2d'); if (usageChart) usageChart.destroy();
                // Show subscription breakdown as horizontal bars
                const subData = data.by_subscription || {};
                const subLabels = Object.keys(subColors);
                const subValues = subLabels.map(s => { const d = subData[s]; return typeof d==='object' ? (d.input_tokens||0)+(d.output_tokens||0) : Number(d)||0; });
                usageChart = new Chart(ctx, { type: 'bar', data: { labels: subLabels.map(s => s.toUpperCase()), datasets: [{ data: subValues, backgroundColor: subLabels.map(s => subColors[s]), borderRadius: 3 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { grid: { color: '#2a2e3a' }, ticks: { color: '#71717a', font: { size: 8 }, callback: v => formatNumber(v) } }, y: { grid: { display: false }, ticks: { color: '#e4e4e7', font: { size: 9, weight: 'bold' } } } }, plugins: { legend: { display: false } } } });
                const bySubData = data.by_subscription || {}, subTotals = {}; for (const [s,i] of Object.entries(bySubData)) subTotals[s] = typeof i==='object' ? (i.input_tokens||0)+(i.output_tokens||0) : Number(i)||0;
                const maxSub = Math.max(...Object.values(subTotals), 1);
                document.getElementById('usage-by-sub').innerHTML = Object.entries(subColors).map(([sub,color]) => { const val = subTotals[sub]||0, pct = (val/maxSub)*100, shortSub = sub.length > 4 ? sub.slice(0,4) : sub; return `<div class="flex items-center gap-1 whitespace-nowrap"><span class="w-8 truncate">${shortSub}</span><div class="flex-1 bg-dark-border rounded-full h-1"><div style="width:${pct}%;background:${color}" class="h-full rounded-full"></div></div><span class="text-dark-muted w-6 text-right">${formatNumber(val)}</span></div>`; }).join('');
                const byClientData = data.by_client || {}, clientTotals = {}; for (const [c,i] of Object.entries(byClientData)) clientTotals[c] = typeof i==='object' ? (i.input_tokens||0)+(i.output_tokens||0) : Number(i)||0;
                const clientEntries = Object.entries(clientTotals).sort((a,b) => b[1]-a[1]), maxClient = clientEntries[0]?.[1]||1;
                document.getElementById('usage-by-client').innerHTML = clientEntries.length===0 ? '<div class="text-dark-muted">â€”</div>' : clientEntries.slice(0,4).map(([c,val],i) => { const pct = (val/maxClient)*100, color = clientColors[i%clientColors.length]; return `<div class="flex items-center gap-1"><span class="w-10 font-mono truncate">${c}</span><div class="flex-1 bg-dark-border rounded-full h-1"><div style="width:${pct}%;background:${color}" class="h-full rounded-full"></div></div><span class="text-dark-muted w-6 text-right">${formatNumber(val)}</span></div>`; }).join('');
            } catch (e) { console.error(e); }
        }

        async function fetchLimits() {
            try {
                const data = await (await fetch('/admin/limits')).json(), accounts = data.accounts || [];
                const render = (a,p,showTarget) => { 
                    const u = Number(a[p]?.utilization)||0;
                    const color = u>=80?'bg-red-500':u>=50?'bg-amber-500':'bg-green-500'; 
                    const shortId = a.id.length > 4 ? a.id.slice(0,4) : a.id;
                    // Calculate target (expected usage based on time elapsed)
                    let targetPct = 0;
                    if (showTarget && a[p]?.resets_at) {
                        const resetTime = new Date(a[p].resets_at);
                        const now = new Date();
                        const hoursUntilReset = (resetTime - now) / 3600000;
                        const totalHours = p === 'five_hour' ? 5 : 168; // 5h or 7 days
                        const hoursElapsed = totalHours - hoursUntilReset;
                        targetPct = Math.max(0, Math.min(100, (hoursElapsed / totalHours) * 100));
                    }
                    const targetMarker = showTarget && targetPct > 0 ? `<div class="absolute top-0 bottom-0 w-0.5 bg-white opacity-60" style="left:${targetPct}%"></div>` : '';
                    const status = u > targetPct + 5 ? 'ðŸ”º' : u < targetPct - 5 ? 'ðŸ”»' : 'âœ“';
                    return `<div class="flex items-center gap-1 whitespace-nowrap"><span class="w-8 font-mono text-[9px]">${shortId}</span><div class="flex-1 bg-dark-border rounded-full h-1.5 relative overflow-hidden"><div class="${color} h-full rounded-full" style="width:${u}%"></div>${targetMarker}</div><span class="w-10 text-right text-[9px]">${u}%${showTarget ? status : ''}</span></div>`; 
                };
                document.getElementById('limits-5h').innerHTML = accounts.map(a => render(a,'five_hour',false)).join('');
                document.getElementById('limits-7d').innerHTML = accounts.map(a => render(a,'seven_day',true)).join('');
            } catch (e) { console.error(e); }
        }

        async function fetchProfiles() {
            try {
                const data = await (await fetch('/admin/profiles')).json(), profiles = data.profiles || {}, entries = Object.entries(profiles);
                const icons = { light: 'ðŸŸ¢', medium: 'ðŸŸ¡', heavy: 'ðŸ”´' };
                document.getElementById('bot-profiles').innerHTML = entries.length===0 ? '<div class="text-dark-muted">No bots</div>' : entries.map(([bot,p]) => `<div class="flex justify-between"><span class="font-mono">${bot}</span><span>${icons[p.classification]||'ðŸŸ¢'} ${formatNumber(p.avg_tokens_day)}/d</span></div>`).join('');
            } catch (e) {}
        }

        // Flow visualization
        const flowCanvas = document.getElementById('flow-canvas'), flowCtx = flowCanvas.getContext('2d');
        let flowParticles = [], flowClients = [], flowSubs = [], clientTokens = {}, activeClients = {};

        function resizeFlowCanvas() { const r = flowCanvas.getBoundingClientRect(); flowCanvas.width = r.width * devicePixelRatio; flowCanvas.height = r.height * devicePixelRatio; flowCtx.scale(devicePixelRatio, devicePixelRatio); }
        resizeFlowCanvas(); window.addEventListener('resize', resizeFlowCanvas);

        class Particle {
            constructor(sx,sy,ex,ey,color,size) { this.sx=sx; this.sy=sy; this.ex=ex; this.ey=ey; this.color=color; this.size=size; this.p=0; this.speed=0.012+Math.random()*0.008; this.trail=[]; }
            update() { this.p += this.speed; const t = this.p<0.5 ? 2*this.p*this.p : 1-Math.pow(-2*this.p+2,2)/2, x = this.sx+(this.ex-this.sx)*t, y = this.sy+(this.ey-this.sy)*t; this.trail.unshift({x,y}); if(this.trail.length>6) this.trail.pop(); return this.p<1; }
            draw(ctx) { this.trail.forEach((p,i) => { ctx.beginPath(); ctx.arc(p.x,p.y,this.size*(1-i*0.1),0,Math.PI*2); ctx.fillStyle = this.color.replace('1)',`${0.8-i*0.12})`); ctx.fill(); }); }
        }

        function spawnParticle(ci,si,isIn,size) {
            const r = flowCanvas.getBoundingClientRect(), w=r.width, h=r.height, cx=w/2, cy=h/2;
            const clientY = 18 + ci*30, subY = 18 + si*35;
            const sx = isIn?70:cx, sy = isIn?clientY:cy, ex = isIn?cx:w-70, ey = isIn?cy:subY;
            // Use client's color for particles
            const clientColor = clientColors[ci] || '#06b6d4';
            const rgbMatch = clientColor.match(/^#([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i);
            const particleColor = rgbMatch ? `rgba(${parseInt(rgbMatch[1],16)},${parseInt(rgbMatch[2],16)},${parseInt(rgbMatch[3],16)},1)` : 'rgba(34,211,238,1)';
            flowParticles.push(new Particle(sx, sy, ex, ey, particleColor, size));
        }

        function updateFlowData() {
            Promise.all([
                fetch('/admin/clients').then(r=>r.json()), 
                fetch('/admin/flow?minutes=5').then(r=>r.json()),
                fetch('/admin/flow?minutes=1').then(r=>r.json())
            ])
            .then(([cd, fd, recentFd]) => {
                flowSubs = cd.live.subscriptions.map(s => s.name);
                const flows = fd.flows || [], cs = new Set(); flows.forEach(f => cs.add(f.from));
                flowClients = Array.from(cs).slice(0, 5);
                // Track active clients (had flow in last 15 seconds)
                activeClients = {};
                (recentFd.flows || []).forEach(f => { if (f.tokens > 0) activeClients[f.from] = true; });
                let max = 1; flows.forEach(f => { clientTokens[f.from] = (clientTokens[f.from]||0) + f.tokens; if(clientTokens[f.from] > max) max = clientTokens[f.from]; });
                flows.forEach(f => {
                    const ci = flowClients.indexOf(f.from), si = flowSubs.indexOf(f.to);
                    if (ci<0 || si<0) return;
                    const rate = Math.min(0.85, 0.1 + (f.tokens/max)*0.75), sz = 2 + (f.tokens/max)*2;
                    if (Math.random() < rate) { const burst = Math.ceil(1+(f.tokens/max)*2); for(let b=0;b<burst;b++) setTimeout(()=>{ if(f.input_tokens) spawnParticle(ci,si,true,sz); setTimeout(()=>{ if(f.output_tokens) spawnParticle(ci,si,false,sz*0.8); },100+Math.random()*150); },b*60); }
                });
            }).catch(()=>{});
        }

        function drawFlow() {
            const r = flowCanvas.getBoundingClientRect(), w=r.width, h=r.height, cx=w/2, cy=h/2;
            flowCtx.clearRect(0,0,w,h);
            flowCtx.strokeStyle = 'rgba(42,46,58,0.4)'; flowCtx.lineWidth = 1;
            // Connection lines
            flowClients.forEach((c,i) => { const y=18+i*30; flowCtx.beginPath(); flowCtx.moveTo(70,y); flowCtx.quadraticCurveTo(cx-40,y,cx,cy); flowCtx.stroke(); });
            flowSubs.forEach((s,i) => { const y=18+i*35; flowCtx.beginPath(); flowCtx.moveTo(cx,cy); flowCtx.quadraticCurveTo(cx+40,y,w-70,y); flowCtx.stroke(); });
            // Client boxes - BIGGER, pulse green if active
            flowClients.forEach((c,i) => { 
                const y=18+i*30;
                const isActive = activeClients[c];
                // Glow effect for active clients
                if (isActive) {
                    const pulse = 0.5 + 0.5 * Math.sin(Date.now() / 200);
                    flowCtx.shadowColor = '#22c55e';
                    flowCtx.shadowBlur = 8 + pulse * 8;
                }
                flowCtx.fillStyle='#1a1d27'; 
                flowCtx.strokeStyle = isActive ? '#22c55e' : clientColors[i]; 
                flowCtx.lineWidth = isActive ? 2.5 : 2; 
                flowCtx.beginPath(); flowCtx.roundRect(5,y-12,65,24,4); flowCtx.fill(); flowCtx.stroke(); 
                flowCtx.shadowBlur = 0;
                flowCtx.fillStyle = isActive ? '#22c55e' : '#e4e4e7'; 
                flowCtx.font = isActive ? 'bold 11px monospace' : '11px monospace'; 
                flowCtx.textAlign='center'; flowCtx.fillText(c.slice(0,7),37,y+4); 
            });
            // Load balancer - SMALLER
            const grad = flowCtx.createRadialGradient(cx,cy,0,cx,cy,18); grad.addColorStop(0,'rgba(59,130,246,0.25)'); grad.addColorStop(1,'rgba(59,130,246,0)');
            flowCtx.fillStyle=grad; flowCtx.beginPath(); flowCtx.arc(cx,cy,18,0,Math.PI*2); flowCtx.fill();
            flowCtx.fillStyle='#1a1d27'; flowCtx.strokeStyle='#3b82f6'; flowCtx.lineWidth=2; flowCtx.beginPath(); flowCtx.arc(cx,cy,14,0,Math.PI*2); flowCtx.fill(); flowCtx.stroke();
            flowCtx.fillStyle='#e4e4e7'; flowCtx.font='bold 9px sans-serif'; flowCtx.textAlign='center'; flowCtx.fillText('LB',cx,cy+3);
            // Subscription boxes - BIGGER
            flowSubs.forEach((s,i) => { 
                const y=18+i*35, color=subColors[s]||'#666'; 
                flowCtx.fillStyle='#1a1d27'; flowCtx.strokeStyle=color; flowCtx.lineWidth=2; 
                flowCtx.beginPath(); flowCtx.roundRect(w-70,y-14,65,28,4); flowCtx.fill(); flowCtx.stroke(); 
                flowCtx.fillStyle='#e4e4e7'; flowCtx.font='bold 12px monospace'; flowCtx.textAlign='center'; flowCtx.fillText(s.toUpperCase(),w-37,y+5); 
            });
            // Draw particles
            flowParticles = flowParticles.filter(p => { const alive = p.update(); p.draw(flowCtx); return alive; });
        }

        function animate() { drawFlow(); requestAnimationFrame(animate); }

        fetchClients(); fetchUsage(); fetchLimits(); fetchProfiles(); updateFlowData();
        setInterval(fetchClients, 5000); setInterval(fetchUsage, 30000); setInterval(fetchLimits, 60000); setInterval(fetchProfiles, 60000); setInterval(updateFlowData, 1500);
        animate();
    </script>
</body>
</html>
